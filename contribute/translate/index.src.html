<div class="edit-slot"></div>

<div class="translate-slot"></div>

<script>
    function formatLanguage(language, extraClasses) {
        return '<div class="link ' + extraClasses + '">' +
                '<a><span class="chip">' + language.id + '</span>' + language.isoName + (language.regionName ? ' (' + language.regionName + ')' : '') + (language.variant ? ' (' + language.variant + ')' : '') + '</a>' +
            '</div>';
    }

    var english = {};

    $.getJSON('/contribute/translate/assets/translations/en.json', function (translations) {
        english = translations;
    });

    $.getJSON('/contribute/translate/assets/languages.json', function (languages) {
        var language = (navigator.language || navigator.userLanguage).split(/[_-]/);
        var region = (language[1] || 'unknown').toUpperCase();
        language = language[0].toLowerCase();
        var preferred = '';
        var count = 0;
        var other = languages.filter(function (item) {
            if (item.code === language) {
                count++;
                preferred += formatLanguage(item, 'preferred' + (item.region === region ? ' favorite' : ''));

                return false;
            }

            return true;
        });
        $('.translate-slot').html(
            '<p>Based on your browser\'s settings, ' +
                (count
                    ? 'we detected ' + count + ' language' + (count === 1 ? '' : 's') + ' you may know. Please check if there is no mistake and add words that could be missing.'
                    : 'your language seems not yet available in Carbon, add it!'
                ) +
            '</p>' +
            '<p>'+
                'Add a new language if it\'s not yet available: ' +
                '<input class="new-language" placeholder="Language name / ISO 639-1 code" style="width: 300px;">' +
                '<input class="add-new-language" type="button" value="Add">' +
            '</p>' +
            '<p>'+
                'Or pick one of the following:' +
            '</p>' +
            preferred + other.map(formatLanguage).join('')
        );
    }, function (error) {
        console.warn(error);
    });

    var editLanguage = null;

    function loadLanguage(language) {
        $('.translate-slot').hide();
        $('.edit-slot').text('Loading...');

        var lines = [
            ['CarbonInterval::years(2)', '->forHumans()'],
            ['CarbonInterval::years(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::year()', '->forHumans()'],
            ['CarbonInterval::year()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::months(2)', '->forHumans()'],
            ['CarbonInterval::months(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::month()', '->forHumans()'],
            ['CarbonInterval::month()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::weeks(2)', '->forHumans()'],
            ['CarbonInterval::weeks(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::week()', '->forHumans()'],
            ['CarbonInterval::week()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::days(2)', '->forHumans()'],
            ['CarbonInterval::days(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::day()', '->forHumans()'],
            ['CarbonInterval::day()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::hours(2)', '->forHumans()'],
            ['CarbonInterval::hours(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::hour()', '->forHumans()'],
            ['CarbonInterval::hour()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::minutes(2)', '->forHumans()'],
            ['CarbonInterval::minutes(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::minute()', '->forHumans()'],
            ['CarbonInterval::minute()', '->forHumans(["aUnit" => true])'],
            ['CarbonInterval::seconds(2)', '->forHumans()'],
            ['CarbonInterval::seconds(2)', '->forHumans(["short" => true])'],
            ['CarbonInterval::second()', '->forHumans()'],
            ['CarbonInterval::second()', '->forHumans(["aUnit" => true])'],
            'Warning, do not uppercase the first letter if it\'s not required, days/months are always uppercase in English, so "Monday" is written this way even in a sentence like "See you Monday", please translate the following as if it could be in the middle of such sentences. Short versions are used in short date formats and minimalist days are used calendar headings and such custom usages.',
            ['Carbon::parse("monday")', '->dayName'],
            ['Carbon::parse("monday")', '->shortDayName'],
            ['Carbon::parse("monday")', '->minDayName'],
            ['Carbon::parse("tuesday")', '->dayName'],
            ['Carbon::parse("tuesday")', '->shortDayName'],
            ['Carbon::parse("tuesday")', '->minDayName'],
            ['Carbon::parse("wednesday")', '->dayName'],
            ['Carbon::parse("wednesday")', '->shortDayName'],
            ['Carbon::parse("wednesday")', '->minDayName'],
            ['Carbon::parse("thursday")', '->dayName'],
            ['Carbon::parse("thursday")', '->shortDayName'],
            ['Carbon::parse("thursday")', '->minDayName'],
            ['Carbon::parse("friday")', '->dayName'],
            ['Carbon::parse("friday")', '->shortDayName'],
            ['Carbon::parse("friday")', '->minDayName'],
            ['Carbon::parse("saturday")', '->dayName'],
            ['Carbon::parse("saturday")', '->shortDayName'],
            ['Carbon::parse("saturday")', '->minDayName'],
            ['Carbon::parse("sunday")', '->dayName'],
            ['Carbon::parse("sunday")', '->shortDayName'],
            ['Carbon::parse("sunday")', '->minDayName'],
            ['Carbon::parse("january 2023")', '->monthName'],
            ['Carbon::parse("january 2023")', '->shortMonthName'],
            ['Carbon::parse("february 2023")', '->monthName'],
            ['Carbon::parse("february 2023")', '->shortMonthName'],
            ['Carbon::parse("march 2023")', '->monthName'],
            ['Carbon::parse("march 2023")', '->shortMonthName'],
            ['Carbon::parse("april 2023")', '->monthName'],
            ['Carbon::parse("april 2023")', '->shortMonthName'],
            ['Carbon::parse("may 2023")', '->monthName'],
            ['Carbon::parse("may 2023")', '->shortMonthName'],
            ['Carbon::parse("june 2023")', '->monthName'],
            ['Carbon::parse("june 2023")', '->shortMonthName'],
            ['Carbon::parse("july 2023")', '->monthName'],
            ['Carbon::parse("july 2023")', '->shortMonthName'],
            ['Carbon::parse("august 2023")', '->monthName'],
            ['Carbon::parse("august 2023")', '->shortMonthName'],
            ['Carbon::parse("september 2023")', '->monthName'],
            ['Carbon::parse("september 2023")', '->shortMonthName'],
            ['Carbon::parse("october 2023")', '->monthName'],
            ['Carbon::parse("october 2023")', '->shortMonthName'],
            ['Carbon::parse("november 2023")', '->monthName'],
            ['Carbon::parse("november 2023")', '->shortMonthName'],
            ['Carbon::parse("december 2023")', '->monthName'],
            ['Carbon::parse("december 2023")', '->shortMonthName'],
            ['Carbon::now()->subHours(2)', '->diffForHumans()'],
            ['Carbon::now()->addHours(2)->addMinute()', '->diffForHumans(["part" => 1])'],
            ['($d = Carbon::now())->copy()->subHours(2)', '->diffForHumans($d)'],
            ['($d = Carbon::now())->copy()->addHours(2)->addMinute()', '->diffForHumans($d)']
        ];

        $.getJSON('/contribute/translate/assets/translations/' + language + '.json', function (translations) {
            $('.edit-slot').html('<table><tr><th>English</th><th style="padding: 0 20px;">' + editLanguage + '</th><th>' + (language ? 'Fix and comments' : 'Translation in ' + editLanguage) + '</th></tr>' + lines.map(function (line) {
                return typeof line === 'string'
                    ? '<tr class="translate-line"><td colspan="3" style="padding: 10px 0; font-weight: bold;">' + line + '</td></tr>'
                    : '<tr class="translate-line"><td>' + (english[line[0] + line[1]] || line[0] + line[1]) + '</td><td style="padding: 0 20px;">' + (translations[line[0] + line[1]] || '??') + '</td><td><textarea style="width: 400px; height: 26px;" placeholder="' + (language ? 'This should rather be... because...' : 'Translation in ' + editLanguage) + '"></textarea></td></tr>';
            }).join('') + '</table>' +
            '<div style="padding-top: 10px;">' +
                '<p><textarea class="additional-fixes" cols="70" rows="4" placeholder="If what you wish to fix does not appear in the table, please add it here."></textarea></p>' +
                '<p><textarea class="additional-comments" cols="70" rows="4" placeholder="Precise here anything else we may need to know"></textarea></p>' +
                '<p>By clicking on Submit, you will be redirected to GitHub where you will be required to be logged in (it allows us to keep a trace of your authorship and centralize requests).</p>' +
                '<input class="submit-language" type="button" value="Submit" disabled>' +
            '</div>');
        }, function (error) {
            $('.edit-slot').text('Loading error. Please try later.');
            $('.translate-slot').show();
            console.warn(error);
        });
    }

    function uriParam(name, value) {
        return name + '=' + encodeURIComponent(value);
    }

    function getIssue() {
        var issue = '';
        $('.translate-line').each(function () {
            var cells = $(this).find('td');
            var value = cells.eq(2).find('textarea').val();
            if (value) {
                issue += '|' + cells.eq(0).text() + '|' + cells.eq(1).text() + '|' + value + '|\n';
            }
        });
        if (issue) {
            issue = '|English|' + editLanguage + '|comments|\n' +
                '|--|--|--|\n' + issue;
        }
        var fixes = $('.additional-fixes').val();
        if (fixes) {
            issue += '\n## Additional fixes\n' + fixes;
        }
        var comments = $('.additional-comments').val();
        if (comments) {
            issue += '\n\n----\n' + comments;
        }

        return issue;
    }

    $(document)
        .on('change keyup', '.edit-slot textarea', function () {
            $('.submit-language').prop('disabled', ![].join.call($('.edit-slot textarea').map(function () {
                return $(this).val();
            }), '').length);
        })
        .on('click', '.submit-language', function () {
            window.open('https://github.com/briannesbitt/Carbon/issues/new?' + uriParam('title', '[Translation tool] ' + editLanguage) + '&' + uriParam('body', getIssue()));
        })
        .on('click', '.translate-slot a', function (event) {
            event.stopPropagation();
            event.preventDefault();

            editLanguage = $(this).find('.chip').text();
            loadLanguage(editLanguage);
        })
        .on('click', '.add-new-language', function () {
            var $field = $('.new-language');
            editLanguage = $field.val();
            $field.val('');
            loadLanguage();
        })
    ;
</script>
