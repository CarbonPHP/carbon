<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
        <title>Carbon - A simple PHP API extension for DateTime.</title>
        <meta name="description" content="Carbon - A simple PHP API extension for DateTime.">
        <link href='//fonts.googleapis.com/css?family=Open+Sans:400,300,600' rel='stylesheet' type='text/css'>
        <link href="//cdn.jsdelivr.net/npm/bootstrap@3.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
        <link href="//cdn.jsdelivr.net/npm/highlight.js@8.4.0/styles/tomorrow-night.min.css" rel="stylesheet">
        <link href="/carbon.css?v=2019-08-01-21-40" rel="stylesheet">
        <script>
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r;
                i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
                a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0];
                a.async = 1;
                a.src = g;
                m.parentNode.insertBefore(a, m)
            })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-27020320-3', 'auto');
            ga('send', 'pageview');

        </script>
    </head>
    <body data-spy="scroll" data-target="#affix-nav">

    <div class="main-wrapper">
        <aside id="reference">
            <div class="search-wrapper">
                <div class="search-bar">
                    <div class="input-group">
                        <span class="input-group-addon">
                            <i class="glyphicon glyphicon-search"></i>
                        </span>
                        <input type="text" class="form-control" placeholder="Search" id="search-filter">
                    </div>
                    <button class="close">&lt;</button>
                </div>
                <div class="search"></div>
            </div>
        </aside>
        <section>
            <nav class="navbar navbar-default navbar-static-top">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                                aria-expanded="false" aria-controls="navbar">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="/"><img src="/logo.png" alt="Carbon" width="159" height="50"></a>
                    </div>
                    <div id="navbar" class="navbar-collapse collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="/#gettingstarted">Getting Started</a></li>
                            <li><a href="/docs/">Docs</a></li>
                            <li><a href="#reference">Reference</a></li>
                            <li><a href="/history/">History</a></li>
                            <li><a href="/contribute/">Contribute</a></li>
                            <li><a href="//github.com/briannesbitt/carbon">GitHub</a></li>
                        </ul>
                    </div>
                </div>
            </nav>



            <div class="container page">
                <div class="row">
                    <div class="col-md-9">
                        <h1 id="time-precision">Time precision</h1>

<p>As soon as you need to store a date (with or without time), you should store a full datetime.
Even if it sounds like you don't need the time, timezone or anything more than the day-precision
for a date such as <code>2020-07-26</code> but July the 26th is not the same day for everyone.
July 26th is a precise period from 07-26 00:00:00 to 07-26 23:59:59.999... But if a person in
New York says 26th July, a person in Auckland talking about the same period would consider
it's 07-26 16:00:00 to 07-27 15:59:59.999... This means if you store only year-month-day dates,
your app can only work in 1 timezone and will never be compatible with any other timezone.</p>

<p>The same way, you won't be able to re-use any date-related component of your app in any
multi-timezones contexts. Nowadays, it make absolutely no sense to work on a mono-timezone
basis. You're 99.99% sure someday your app or a part of your app will be used in more than
1 timezone, so you will need at least to add hour-minute to store worldwide day-precision
(because some timezone have shifts like +4:30 or +8:45), so since you're there, there's
no point to be stingy, you can also store second and then have a standard storing of any
moment no matter the precision you want.</p>

<p>Last, when it comes to precise sorting or you want to take the 3 first people that sent
a request, you will be embarrassed if you see 5 times the same datetime in your log because
people sent requests in the same second.</p>

<p>So, store the maximum precision your engine can (microseconds with PHP and MySQL
for instance) and forget it.</p>

<p>On the long term, this will free your mind, stop worrying about what precision you
got, if you compare 2 moments, you will always have precise difference. Then if you want
to round or truncate a difference, or display in a particular timezone, you still can
because you have the complete data, while if you decide to store less data, it will be
too late to change your mind later regarding existing data.</p>

<p>SQL engines are capable to store date-time millisecond to nanosecond precision, but by default Laravel comes
    with second-precision.</p>

<p>For instance, if you use MySQL, you should extend <code>MySqlGrammar</code> to change the date format:</p>

<pre><code class="php">&lt;?php
// app/Database/Query/Grammars/MySqlGrammar.php

namespace App\Database\Query\Grammars;

class MySqlGrammar extends \Illuminate\Database\Query\Grammars\MySqlGrammar
{
    public function getDateFormat()
    {
        return 'Y-m-d H:i:s.u';
    }
}</code></pre>

<p>Then edit the boot method of <strong>app/Providers/AppServiceProvider.php</strong>:</p>

<pre><code class="php">class AppServiceProvider extends ServiceProvider
{
    /**
    * Bootstrap any application services.
    *
    * @return void
    */
    public function boot()
    {
        DB::connection()->setQueryGrammar(new \App\Database\Query\Grammars\MySqlGrammar);
    }</code></pre>

<p>Then to be properly stored this precision, add the precision attribute (6 for 6-digits length decimal part) in
    migrations, for instance the default migration of users would become to store the microseconds precision:</p>

<pre><code class="php">Schema::create('users', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('email')->unique();
    $table->timestamp('email_verified_at', 6)->nullable();
    $table->string('password');
    $table->rememberToken();
    $table->timestamps(6);
});</code></pre>

<p>If the migration has already been ran, use an update:</p>

<pre><code class="php">Schema::table('users', function (Blueprint $table) {
    $table->timestamp('created_at', 6)->nullable();
    $table->timestamp('updated_at', 6)->nullable();
});</code></pre>

<p>Now you can free your mind from this point and use <code>->timestamp('x', 6)</code>
each time you need to store any date or time related data.</p>

<h1 id="localization">Localization</h1>

<p>When storing a datetime, you should also consider the location where this moment is
considered, you can store it with any timezone. If a user buy an airplane flight
ticket, you may want to display departure time (with origin timezone), arrival
time (with destination timezone) and let's say also online check-in deadline and
order time (with current browser timezone).</p>

<p>Here you can distinguish dates to be considered in a fixed timezone (departure
and arrival) and the ones that can actually be displayed in any timezone.</p>

<p>Let's see the departure/arrival first. You may be tempted to just store date
considered in each airport. So flying from Reykjavik (‏KEF)‏ to Athènes (‏ATH)‏, you
can get 2020-11-04 10:00 and 2020-11-04 14:00, this would allow you to display
the raw data: 10:00 (REK) -&gt; 14:00 (ATH), great. But now to calculate the
flight duration, you will need to convert one or the other to get the diff
because the flight is 6-hour and not 4-hour long. And even more tricky, let's
now output the 5 next flights. You have mixed timezones in your DB (database),
so you can't rely on the DB optimizations to sort and limit the result. You can't
even now which flight already took off or not without converting every date
in a reference timezone. That's a shame.</p>

<p>That's why, in your DB, <strong>every dates</strong> should be stored in
the same timezone. This way, you can sort, compare, sub/add with no conversion.</p>

<h2>Which timezone to choose?</h2>

<p>Many businesses/organizations made the mistake of taking their business or server
location as the reference timezone. You should think bigger! Someday you may move your
server, become an international company, or you may simply want to reuse a part
of your app or your DB. Then the timezone your originally picked will make
absolutely no sense, and if you have to merge with an other DB, it will no longer
be consistent.</p>

<p>Even worse, if you choose a timezone with DST as reference (USA, Europe, etc.)
then you will have calculation errors (for instance, the given flight above will
give you 5 or 7 hours instead of 6 when there is a DST change in your reference
timezone during the flight).</p>

<h2>UTC is the reference</h2>

<p>The worldwide time system standard is UTC, it defines each timezone from
GMT (Greenwich Mean Time) +/- a given time shift. So to maximize your compatibility
and avoid painful issues, use <code>'UTC'</code> as the default timezone of
your app and to store any moment in your DB or any other storage.</p>

<p>This is also the timezone you should choose for your APIs. For instance, in
a JSON API, a date should looks like <code>"2020-03-19T08:44:40.593Z"</code>,
Browser will understand <code>Z</code> as Zulu timezone (an other synonym for
<code>GMT+0</code> or <code>UTC+0</code>) and for instance, if you call
<code>new Date("2020-03-19T08:44:40.593Z")</code> in Paris, you'll get
<code>Thu Mar 19 2020 09:44:40 GMT+0100 (Central European Standard Time)</code>,
if you call it in New York:
<code>Thu Mar 19 2020 04:44:40 GMT-0400 (Eastern Daylight Time)</code>.
This would actually be the better way for check-in deadline and
order time in the example above.</p>

<p>This actually means you will convert dates to an other timezone server-side
very rarely, only if you have to display it in a view.</p>

<p>In the previous example, the timezone could be calculated from airport
localization, if you need a fixed timezone but don't have the needed data
stored to retrieve it, then you should simply add a <code>text</code> column
in your DB table to store <code>"Europe/Paris"</code> or <code>"America/New_York"</code>.
Use the city timezones and not the shift (like <code>UTC+08</code>) else
you won't be able to know which DST rules to apply if you have to modify the
date or calculate a new date based on the first one.</p>

<p>Last, you don't need to store a timezone string for each timezone-fixed date,
you should apply the logic relation/grouping according to your need. For instance,
if you want to send e-mails with dates to your users, you can't access the browsers
when sending mails so you have to pick a timezone, you can use the last known
timezone of the user (supposing you update some users table field with the
browser timezone when a user log in your app). In this case, you obviously don't
need to store the timezone for each stored date, you can simply save one and reuse
it for every dates in all e-mails for a given user.</p>

<p>Laravel comes with <code>'UTC'</code> as default timezone, you can check and fix
it in the <strong>config/app.php</strong> file:</p>

<pre><code class="php">/*
|--------------------------------------------------------------------------
| Application Timezone
|--------------------------------------------------------------------------
|
| Here you may specify the default timezone for your application, which
| will be used by the PHP date and date-time functions. We have gone
| ahead and set this to a sensible default for you out of the box.
|
*/

'timezone' => 'UTC',</code></pre>

<p><a href="/docs">Continue to read more with the documentation.</a></p>



                    </div>

    <div class="col-md-3">
        <div id="affix-nav" class="hidden-print hidden-xs hidden-sm affix">
            <ul class="nav sidenav" data-spy="affix" data-offset-top="10">
                <li><a href="#time-precision">Time precision</a></li>
                <li><a href="#localization">Localization</a></li>
            </ul>
        </div>
    </div>

                </div>
            </div>
        </section>
    </div>

    <footer>
        <div class="help-translate">
            <a href="#" class="close" data-session-close="footer .help-translate">✖</a>
            Do you speak <strong>#{language}</strong>? You can help Carbon to
            <a href="/contribute/translate/">improve its translations</a>!<br>
            No coding skills needed, <a href="/contribute/translate/">go to translation tool</a>.
        </div>
        <div class="available-slot container">
            <a href="#" class="close" data-session-close="footer .available-slot">✖</a>
            <div data-ea-publisher="carbon" data-ea-type="text"></div>
        </div>
    </footer>

    <script async src="https://media.ethicalads.io/media/client/ethicalads.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/jquery@1.11.2/dist/jquery.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/bootstrap@3.3.2/dist/js/bootstrap.min.js"></script>
    <script>

        var liveEditorHosts = [
            'https://play.phpsandbox.io/embed/nesbot/carbon'
        ];
        var sessStorage = window.sessionStorage || {};
        var storage = window.localStorage || {};
        var balancingId = storage.balancingId || (storage.balancingId = Math.floor(Math.random() * 1024));
        var liveEditorHostIndex = balancingId % liveEditorHosts.length;
        var liveEditorHost = liveEditorHosts[liveEditorHostIndex];
        var callbacks = {};
        var $document = $(document);
        var editorAutoLoad = false;
        var failures = 0;

        function failOver(index) {
            if (index !== liveEditorHostIndex || ++failures >= liveEditorHosts.length) {
                return;
            }

            liveEditorHostIndex++;
            liveEditorHost = liveEditorHosts[liveEditorHostIndex % liveEditorHosts.length];

            var timeout = setTimeout(function () {
                failOver(hostIndex);
            }, 10000);

            $('[data-href-params]').each(function () {
                var $link = $(this);
                $link.prop('href', liveEditorHost + $link.data('href-params'));
            });

            $('[data-src-params]').each(function () {
                var $iframe = $(this);
                $iframe.prop('src', liveEditorHost + $iframe.data('src-params')).data('timeout', timeout);
            });
        }

        function transformEditor($pre, index, code, token, link, params) {
            if (!$pre.hasClass('live-editor') || $pre.hasClass('live-editor-loading')) {
                return;
            }

            $pre.removeClass('live-editor').addClass('live-editor-loading');

            if (!code) {
                code = $pre.find('code').text();
                token = 'live-editor-' + index;
                params = '?input='
                    + encodeURIComponent(code)
                    ; // + '&hide-output-gutter&output-left-padding=10&theme=tomorrow_night&border=none&radius=4&v-padding=15&token=' + token;
                link = liveEditorHost + params;

                if (!$('.link-' + token).length) {
                    $('<a class="live-editor-new-window link-' + token + '" href="' + link + '" data-href-params="' + params + '" target="_blank"><i class="glyphicon glyphicon-new-window"></i></a>').insertBefore($pre);
                }
            }

            var timeout = setTimeout(function () {
                failOver(hostIndex);
            }, 10000);
            var hostIndex = liveEditorHostIndex;
            var $iframe = $('<iframe src="' + link +
                '&embed" data-src-params="' + params +
                '&embed" data-timeout="' + timeout +
                '" onerror="failOver(' + hostIndex + ')" style="width: 100%; border: none; opacity: 0; pointer-events: none; position: absolute;"></iframe>').insertAfter($pre);

            $iframe.css({
                opacity: 1,
                pointerEvents: 'all',
                position: '',
                height: $pre.outerHeight() + 'px'
            });
            $pre.hide();
            // (callbacks[token] || (callbacks[token] = {})).ready = function () {
            //     clearTimeout($iframe.data('timeout'));
            //
            //     $iframe.css({
            //         opacity: 1,
            //         pointerEvents: 'all',
            //         position: '',
            //         height: $pre.outerHeight() + 'px'
            //     });
            //     $pre.hide();
            // };
        }

        var scrollCheckDebounce = null;

        function scrollCheck() {
            if (scrollCheckDebounce) {
                clearTimeout(scrollCheckDebounce);
            }

            scrollCheckDebounce = setTimeout(function () {
                $('.live-editor').each(function (index) {
                    var $pre = $(this);
                    if (!editorAutoLoad) {
                        var code = $pre.find('code').text();
                        var token = 'live-editor-' + index;
                        var params = '?hide-output-gutter&output-left-padding=10&theme=tomorrow_night&border=none&radius=4&v-padding=15&input=' +
                            encodeURIComponent(code) +
                            '&token=' + token;
                        var link = liveEditorHost + params;
                        $pre.css('cursor', 'pointer').click(function () {
                            transformEditor($pre, index, code, token, link, params);
                        });

                        if (!$('.link-' + token).length) {
                            $('<a class="live-editor-new-window link-' + token + '" href="' + link + '" target="_blank"><i class="glyphicon glyphicon-new-window"></i></a>').insertBefore($pre);
                        }

                        return;
                    }

                    var scrollTop = $document.scrollTop();
                    var scrollBottom = scrollTop + $(window).height();
                    var viewMargin = 400;
                    var top = $pre.offset().top;
                    if (top + $pre.outerHeight() + viewMargin > scrollTop && top - viewMargin < scrollBottom) {
                        transformEditor($pre, index);
                    }
                });
            }, 1000);
        }

        function openDocPanel(className, selection) {
            $('#search-filter').val('');
            refreshDoc();
            $('.main-wrapper').addClass('open');
            $('#doc-method-' + className + '-' + selection)[0].scrollIntoView();
        }

        function openDoc(event, selection, token) {
            selection = $.trim(selection);
            if (/^[a-zA-Z0-9_-]+$/.test(selection)) {
                var options = [];

                $.each(['Carbon', 'CarbonInterval', 'CarbonPeriod'], function (index, className) {
                    var element = $('#doc-method-' + className + '-' + selection)[0];
                    if (element) {
                        options.push([className, selection, element]);
                    }
                });

                $('#open-doc-menu').remove();
                var $menu = $('.modal-menu');

                if ($menu.length === 0) {
                    $menu = $('<div class="modal-menu">').appendTo('body');
                }

                $(document).one('click', function () {
                    $menu.remove();
                });

                var pageX = event.pageX | 0;
                var pageY = event.pageY | 0;

                if (typeof event.pageX === 'undefined') {
                    var $currentEditor = $('iframe[src*="' + token + '"]');
                    pageX = $currentEditor.offset().left;
                    pageY = $currentEditor.offset().top;
                }

                var modalHeight = options.length * 26 + 10;
                var scrollTop = $document.scrollTop();

                $menu.css({
                    left: pageX + 'px',
                    top: Math.max(scrollTop, pageY - modalHeight) + 'px'
                }).html(options.map(function (option) {
                    return '<div class="modal-menu-item" onclick="openDocPanel(\'' + option[0] + '\', \'' + option[1] + '\')">' + option[0] + '::<strong>' + option[1] + '</strong></div>';
                }).join(''));
            }
        }

        var $search = $('#main-search-bar');

        if ($search.length) {
            function search(word) {
                var list = $('#docs *, #reference *').filter(function (index, element) {
                    return $(element).find('script').length === 0 && (new RegExp(word, 'i')).test(element.innerText);
                });

                var copy = list.slice();

                copy.each(function (index, element) {
                    list = list.filter(function (i, e) {
                        return e !== element.parentNode;
                    });
                });

                var result = [];

                list.each(function (i, e) {
                    while (e.parentNode && ~['inline', 'table-cell'].indexOf(window.getComputedStyle(e).display)) {
                        e = e.parentNode;
                    }

                    if (e !== result[result.length - 1]) {
                        result.push(e);
                    }
                });

                return result;
            }

            var searchValue = $search.val().trim();
            var timeout = null;

            $search.on('change input keyup keypress', function () {
                var newValue = $search.val().trim();

                if (newValue.length === 0) {
                    if (timeout) {
                        clearTimeout(timeout);
                    }

                    $('#search-result').hide();
                    $('#docs').removeClass('height-squeezed');

                    return;
                }

                $('#docs').addClass('height-squeezed');

                if (newValue.length < 2) {
                    if (timeout) {
                        clearTimeout(timeout);
                    }

                    $('#search-result').show().html('<p>Type at least 2 letters to start the search.</p>');

                    return;
                }

                if (searchValue !== newValue) {
                    if (timeout) {
                        clearTimeout(timeout);
                    }

                    searchValue = newValue;

                    $('#search-result').show().html('<p>Searching...</p>');

                    timeout = setTimeout(function () {
                        timeout = null;
                        var result = search(searchValue);

                        if (result.length === 0) {
                            $('#search-result').html('<p>No matches found.</p>');

                            return;
                        }

                        window.goToSearchResult = function (index) {
                            if (result[index]) {
                                var $element = $(result[index]);

                                if ($element.length) {
                                    if ($element.parents('#reference').length) {
                                        $('.main-wrapper').addClass('open');
                                    }

                                    $('#search-result').hide();
                                    $('#docs').removeClass('height-squeezed');
                                    $search.val('');

                                    setTimeout(function () {
                                        $element[0].scrollIntoView();
                                    }, 1);
                                }
                            }
                        };

                        var html = '';

                        result.slice(0, 50).forEach(function (element, index) {
                            var $element = $(element);

                            html += $('<div>').append($('<' + ($element.is('code') ? 'pre' : 'p') + ' class="search-result-item" onclick="goToSearchResult(' + index + ');">').text($element.text())).html().replace(new RegExp(searchValue, 'i'), function (word) {
                                return '<span class="highlight">' + word + '</span>';
                            });
                        });

                        $('#search-result').html(html + (result.length > 50 ? '<p>' + (result.length - 50) + ' results omitted, type more to filter results.</p>' : ''));
                    }, 500);
                }
            });
        }

        var locale = navigator.language || navigator.userLanguage || '';

        $(document)
            .on('click', 'a[data-open-doc]', function (event) {
                event.preventDefault();
                event.stopPropagation();

                var method = $(event.target).data('open-doc').split('::');

                openDocPanel(method[0], method[1]);
            })
            .on('click', '[data-slide-down]', function (event) {
                event.preventDefault();
                event.stopPropagation();

                $($(event.target).data('slide-down')).slideToggle();
            })
            .on('click', '[data-toggle]', function (event) {
                event.preventDefault();
                event.stopPropagation();

                $($(event.target).data('toggle')).toggle();
            })
            .on('click', '[data-session-close]', function (event) {
                event.preventDefault();
                event.stopPropagation();
                var key = $(event.target).data('session-close');
                sessStorage['closed-' + key] = '1';

                $(key).slideUp(200);
            })
        ;

        var $anchor = location.hash && $('[data-toggle="' + location.hash + '"]');

        if ($anchor && $anchor.length) {
            $anchor.click()[0].scrollIntoView();
        }

        var language = (locale.split(/[_-]/)[0] || '').toLowerCase();

        if (!sessStorage['closed-footer .help-translate'] &&
            location.href.indexOf('contribute/translate') === -1 &&
            [
                'af', 'smn', 'si', 'sk', 'sl', 'id', 'ia', 'hy', 'hu', 'ja', 'sn', 'haw',
                'en', 'fr', 'it', 'es', 'pt', 'de', 'ro', 'ru', 'vi', 'ar', 'da', 'nl',
                'cs', 'ka', 'hr', 'gl', 'bg', 'tr', 'sq', 'sr', 'fo', 'fi', 'sv', 'bs',
                'eu', 'or', 'mzn', 'mt', 'ms', 'mk', 'mgo', 'om', 'lt', 'lb', 'kea', 'pl',
                'am', 'ko', 'rm', 'rw', 'fa', 'et', 'uz', 'ur', 'az', 'ca', 'sw', 'vai',
                'yue', 'zh', 'chr', 'nb', 'ee', 'ug', 'el', 'cy', 'to', 'eo'
            ].indexOf(language) === -1
        ) {
            $.getJSON('/languages.json', function (languages) {
                var $help = $('footer .help-translate');
                $help.html($help.html().replace('#{language}', (languages[language] || {}).isoName || language)).show();
            });
        }

        function refreshDoc() {
            var search = $('#search-filter').val().toLowerCase();
            $('.doc-method').each(function () {
                var $method = $(this);
                $method[~$method.find('h2:first').text().toLowerCase().indexOf(search) ? 'show' : 'hide']();
            });
        }

        $('#search-filter').on('keyup change input', refreshDoc);

        window.addEventListener('message', function (event) {
            var data = event.data;
            if (typeof data === 'string') {
                try {
                    data = JSON.parse(data);
                } catch (e) {
                    data = null;
                }
            }
            if (data && data.sender === 'try-carbon') {
                switch (data.event) {
                    case 'ready':
                        var callback = (callbacks[data.token] || {})[data.event];
                        if (typeof callback === 'function') {
                            callback();
                        }
                        break;
                    case 'input':
                        // data.input
                        break;
                    case 'selection':
                        openDoc(event, data.selection, data.token);
                        break;
                }
            }
        });

        scrollCheck();
        $document.scroll(scrollCheck);
        $('.search').scroll(scrollCheck);

        $('.search-wrapper .close').click(function () {
            $('.main-wrapper').removeClass('open');
        });

        $('code').on('mouseup select dblclick', function (event) {
            var s = window.getSelection();
            if ((s.anchorOffset || s.anchorOffset === 0) && s.focusOffset && s.anchorOffset + 1 < s.focusOffset) {
                openDoc(event, s.anchorNode.wholeText.substring(s.anchorOffset, s.focusOffset));
            }
        });

        $('[href="#reference"]').click(function (event) {
            event.preventDefault();
            if ($('.main-wrapper').toggleClass('open').hasClass('open')) {
                $('#search-filter').focus();
            }
        });

        function objEach(obj, callback) {
            var keys = Object.keys(obj);
            for (var i = 0; i< keys.length; i++) {
                callback(keys[i], obj[keys[i]]);
            }
        }

        function reserveEach(obj, callback) {
            var keys = Object.keys(obj);
            for (var i = keys.length - 1; i >= 0; i--) {
                callback(keys[i], obj[keys[i]]);
            }
        }

        $(function () {
            var country = locale.toLowerCase().replace(/^[a-z]+[_-]/, '');

            if (country) {
                $('.' + country + '-country-only').show();
            }

            $('footer').css(
                'padding-right',
                (document.body.offsetWidth - (document.body.scrollWidth || document.body.clientWidth) + 'px')
            );

            $.ajax('/reference/', {
                success: function (data) {
                    $('.search').html(data).find('.live-editor code').each(function (index, block) {
                        hljs.highlightBlock(block);
                    });
                },
            });
            $('.history-slot').each(function () {
                var $slot = $(this);
                var primaryList = {};
                var releases = {};

                function processHistory(data) {
                    $.each(data, function () {
                        primaryList[this.created_at] = this;
                    });
                }

                $.getJSON('/releases.json').then(function (data) {
                    processHistory(data);

                    return $.getJSON('https://api.github.com/repos/briannesbitt/Carbon/releases');
                }).then(function (data) {
                    processHistory(data);

                    Object.keys(primaryList).sort().reverse().forEach(function (key) {
                        var item = primaryList[key];
                        var name = item.tag_name;
                        if (/^\d+\.\d+\.\d/.test(name)) {
                            var major = name.replace(/^(\d+)\..*$/, '$1');
                            var minor = name.replace(/^(\d+\.\d+)\..*$/, '$1');
                            var list = releases[major] || (releases[major] = {});
                            var subList = list[minor] || (list[minor] = {});
                            subList[name] = item;
                        }
                    });

                    var html = '';
                    reserveEach(releases, function (major, list) {
                        html += '<h1 class="history-major-title"><a href="#" data-history-major="' + major + '">Carbon ' + major + '</a></h1><div class="history-major-group history-major-' + major + ' hidden">';
                        objEach(list, function (minor, subList) {
                            html += '<h2 class="history-minor-title">' + minor + '.*</h2><div class="history-minor-group">';
                            objEach(subList, function (version, release) {
                                if (release.assets && release.assets.length) {
                                    release.asset_url = release.assets[0].browser_download_url;
                                }
                                html +=
                                    '<h3>' +
                                        version + '' +
                                        '<small class="release-date" title="' + (new Date(release.created_at)).toLocaleTimeString() + '">' + (new Date(release.created_at)).toLocaleDateString() + '</small>' +
                                        (release.asset_url
                                            ? '<a href="' + release.asset_url + '" class="btn btn-default download-release"><i class="glyphicon glyphicon-save"></i> Download</a>'
                                            : ''
                                        ) +
                                    '</h3>' +
                                    '<div class="version-description">' + ('\n' + release.body).replace(/(\n- [^\n]*)+/g, function (all) {
                                        return '<ul>' + all.replace(/\n- ([^\n]*)/g, '<li>$1</li>') + '</ul>';
                                    }).replace(/^\s+/, '').replace(/\s+$/, '').replace(/\n/g, '<br>').replace(/(https?:\/\/\S+)/g, '<a href="$1" target="_blank">$1</a>') + '</div>'
                                ;
                            });
                            html += '</div>';
                        });
                        html += '</div>';
                    });
                    $slot.html(html).find('.history-major-group').hide().removeClass('hidden');
                });
            });

            $(document).on('click', '[data-history-major]', function (event) {
                $('.history-major-' + $(this).data('history-major')).slideToggle();
                event.preventDefault();
                event.stopPropagation();
            });

            function isLaterInTheMonth(a, b) {
                var diff = (a.getDate() - b.getDate())
                    || (a.getHours() - b.getHours())
                    || (a.getMinutes() - b.getMinutes())
                    || (a.getSeconds() - b.getSeconds())
                    || (a.getMilliseconds() - b.getMilliseconds());

                return diff > 0;
            }

            if ($('.open-collective-list').length) {
                $.getJSON('https://opencollective.com/carbon/members/all.json', function (members) {
                    var date = new Date();
                    var lastYear = new Date();

                    if (lastYear.getMonth() === 1 && lastYear.getDate() === 29) {
                        lastYear.setDate(28);
                    }
                    lastYear.setFullYear(lastYear.getFullYear() - 1);

                    var customSponsorOverride = {"662698":{"name":"Non Gamstop Casinos","description":"Casinos not on Gamstop","image":"https:\/\/lgcnews.com\/wp-content\/uploads\/2018\/01\/LGC-logo-v8-temp.png","website":"https:\/\/lgcnews.com\/"},"663069":{"website":"https:\/\/www.favbet.ua\/uk\/"}};

                    members.forEach(function (member) {
                        Object.assign(member, customSponsorOverride[member.MemberId] || {});
                    });

                    members.push({
                        'MemberId': 1,
                        'createdAt': '2019-01-01 02:00',
                        'type': 'ORGANIZATION',
                        'role': 'BACKER',
                        'tier': 'backer+',
                        'isActive': true,
                        'totalAmountDonated': 1000,
                        'currency': 'USD',
                        'lastTransactionAt': date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate() + ' 02:00',
                        'lastTransactionAmount': 25,
                        'profile': 'https://tidelift.com/',
                        'name': 'Tidelift',
                        'description': 'Get professional support for Carbon',
                        'image': '/docs/sponsors/tidelift-brand.png',
                        'website': 'https://tidelift.com/subscription/pkg/packagist-nesbot-carbon?utm_source=packagist-nesbot-carbon&utm_medium=referral&utm_campaign=docs',
                    });
                    members.push({
                        'MemberId': 2,
                        'createdAt': '2024-11-07 02:00',
                        'type': 'ORGANIZATION',
                        'role': 'BACKER',
                        'tier': 'backer+ yearly',
                        'isActive': true,
                        'totalAmountDonated': 170,
                        'currency': 'USD',
                        'lastTransactionAt': '2024-11-07 02:00',
                        'lastTransactionAmount': 170,
                        'profile': 'https://www.slotozilla.com/nz/free-spins',
                        'name': 'Slotozilla',
                        'description': 'Slotozilla website',
                        'image': '/docs/sponsors/slotozilla.png',
                        'website': 'https://www.slotozilla.com/nz/free-spins',
                    });
                    members.forEach(function (member) {
                        var createdAt = new Date(member.createdAt);
                        var lastTransactionAt = new Date(member.lastTransactionAt);

                        if (isLaterInTheMonth(createdAt, lastTransactionAt)) {
                            createdAt.setDate(lastTransactionAt.getDate());
                            createdAt.setHours(lastTransactionAt.getHours());
                            createdAt.setMinutes(lastTransactionAt.getMinutes());
                            createdAt.setSeconds(lastTransactionAt.getSeconds());
                            createdAt.setMilliseconds(lastTransactionAt.getMilliseconds());
                        }

                        var now = new Date();
                        var currentMonth = now.getMonth();
                        var monthDiff = (now.getFullYear() * 12 + currentMonth) - (createdAt.getFullYear() * 12 + createdAt.getMonth());

                        if (now.getDate() < createdAt.getDate()) {
                            monthDiff--;
                        }

                        var isYearly = ((member.tier || '').toLowerCase().indexOf('yearly') !== -1);

                        var monthlyContribution = (isYearly && lastTransactionAt.getTime() > lastYear.getTime())
                            ? (member.lastTransactionAmount / 11.2) // 11.2 instead of 12 to include the discount for yearly subscription
                            : (member.totalAmountDonated / (1 + monthDiff));

                        if (!isYearly) {
                            var lastMonth = new Date(now.getTime());
                            lastMonth.setMonth(currentMonth);

                            // Overflow
                            while (lastMonth.getMonth() === currentMonth) {
                                lastMonth.setDate(lastMonth.getDate() - 1);
                            }

                            if (lastTransactionAt.getTime() > lastMonth.getTime() &&
                                member.lastTransactionAmount > monthlyContribution
                            ) {
                                monthlyContribution = member.lastTransactionAmount;
                            }

                            var yearDiff = now.getFullYear() - createdAt.getFullYear();

                            if (currentMonth * 31 + now.getDate() < createdAt.getMonth() * 31 + createdAt.getDate()) {
                                yearDiff--;
                            }
                        }

                        var yearlyContribution = isYearly
                            ? (12 * monthlyContribution)
                            : (member.totalAmountDonated / Math.max(1, yearDiff));
                        var status = null;

                        if (monthlyContribution > 29) {
                            status = 'sponsor';
                        } else if (monthlyContribution > 14.5) {
                            status = 'backer';
                        } else if (monthlyContribution > 4.5 || yearlyContribution > 40) {
                            status = 'backer';
                        } else if (member.totalAmountDonated > 0) {
                            status = 'helper';
                        }

                        Object.assign(member, {
                            star: (monthlyContribution > 98 || yearlyContribution > 700),
                            status: status,
                            monthlyContribution: monthlyContribution,
                            yearlyContribution: yearlyContribution
                        });
                    });

                    members.sort(function (a, b) {
                        if (a.monthlyContribution === b.monthlyContribution) {
                            return b.totalAmountDonated - a.totalAmountDonated;
                        }

                        return b.monthlyContribution - a.monthlyContribution;
                    });

                    var memberByUrl = {};
                    members.forEach(function (member) {
                        var url = member.website || member.profile;
                        if (memberByUrl[url]) {
                            return;
                        }

                        memberByUrl[url] = member;
                    });
                    members = Object.values(memberByUrl);

                    ['sponsor', 'backerPlus', 'backer', 'helper'].forEach(function (status) {
                        $('.open-collective-' + status + 's').html(
                            members
                                .filter(function (member) {
                                    return member.status === status;
                                })
                                .map(function (member) {
                                    var href = $('<div>').text(member.website || member.profile).html();
                                    var src = $('<div>').text(member.image || member.profile.replace('https://opencollective.com/', 'https://images.opencollective.com/') + '/avatar/256.png').html();
                                    var size = ({
                                        sponsor: 64,
                                        backerPlus: 48,
                                        backer: 32,
                                    })[member.status] || 24;
                                    var margin = ({
                                        sponsor: 10,
                                        backerPlus: 6,
                                        backer: 5,
                                    })[member.status] || 3;

                                    if ([
                                        'onlinekasyno-polis.pl',
                                        'zonaminecraft.net',
                                        'slotozilla.com',
                                    ].indexOf((new URL(href)).host.replace(/^www\./, '')) === -1) {
                                        href += (href.indexOf('?') === -1 ? '?' : '&amp;') + 'utm_source=opencollective&amp;utm_medium=github&amp;utm_campaign=Carbon';
                                    }

                                    var title = $('<div>').text(member.description || member.name).html();
                                    var alt = $('<div>').text(member.name).html();
                                    var sponsor = (status === 'sponsor');

                                    return '<a style="position: relative; margin: ' + margin + 'px; display: inline-block; border: ' + (size / 8) + 'px solid ' + (member.star ? '#7ac35f' : (sponsor ? '#e3e3e3' : 'transparent')) + ';' + (sponsor ? ' background: white;' : ' border-radius: 50%; overflow: hidden;') + '" title="' + title + '" href="' + href + '" target="_blank">' +
                                        '<img' + (sponsor ? ' onload="adjustImageSize(this)"' : '') + ' onerror="fallbackImage(this)" alt="' + alt + '" src="' + src + '" width="' + size + '" height="' + size + '">' +
                                        (member.star ? '<span style="position: absolute; top: -15px; right: -15px; text-shadow: 0 0 3px black;">⭐</span>' : '') +
                                        '</a>';
                                })
                                .join('')
                        );
                    });
                });
            }
        });

        function adjustImageSize(element) {
            var img = new Image();
            img.onload = function () {
                if (img.width && img.height) {
                    element.width = Math.round(img.width * element.height / img.height);
                }
            };
            img.src = element.src;
        }

        function fallbackImage(element) {
            element.src = 'https://opencollective.com/static/images/default-guest-logo.svg';
        }

    </script>
    <script src="//cdn.jsdelivr.net/npm/highlight.js@8.4.0/lib/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script type="text/javascript">
        var _paq = _paq || [];
        _paq.push(['trackPageView']);
        _paq.push(['enableLinkTracking']);
        (function() {
            var u="//piwik.selfbuild.fr/";
            _paq.push(['setTrackerUrl', u+'piwik.php']);
            _paq.push(['setSiteId', '23']);
            var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
            g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
        })();
    </script>

</body>
</html>
